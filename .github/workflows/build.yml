name: Java CI with Gradle

on:
  pull_request:
    branches: ["develop", "main"]

jobs:
  check-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch names and create RC tags
        run: |
            branch_regex_release='^release/[0-9]+\.[0-9]+\.[0-9]+$'
            branch_regex_feature='^feature/.+$'
            branch_regex_hotfix='^hotfix/.+$'

            head="${{ github.head_ref }}"
            base="${{ github.base_ref }}"

            if [[ "$base" == "main" ]]; then
              if [[ ! "$head" =~ $branch_regex_release ]] && [[ ! "$head" =~ $branch_regex_hotfix ]]; then
                echo "❌ Merge to 'main' is only allowed from release/* or hotfix/* branches."
                exit 1
              fi

              # Create RC tag for release branches
              if [[ "$head" =~ $branch_regex_release ]]; then
                # Extract version (release/1.2.3 → 1.2.3)
                version="${head#release/}"

                # Find latest RC number (1.2.3-rc.1, 1.2.3-rc.2, etc.)
                latest_rc=$(git tag -l "${version}-rc.*" | sort -V | tail -n 1)

                if [[ -z "$latest_rc" ]]; then
                  # First RC tag
                  rc_tag="${version}-rc.1"
                else
                  # Increment RC number (1.2.3-rc.2 → 1.2.3-rc.3)
                  rc_num=$(echo "$latest_rc" | sed 's/.*-rc\.//')
                  next_num=$((rc_num + 1))
                  rc_tag="${version}-rc.${next_num}"
                fi

                # Create and push tag
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git tag -a "$rc_tag" -m "Release candidate $rc_tag for PR #${{ github.event.pull_request.number }}"
                git push origin "$rc_tag"
                echo "✅ RC tag $rc_tag created"
              fi
            elif [[ "$base" == "develop" ]]; then
              if [[ ! "$head" =~ $branch_regex_feature ]] && [[ ! "$head" =~ $branch_regex_hotfix ]]; then
                echo "❌ Merge to 'develop' is only allowed from feature/* or hotfix/* branches."
                exit 1
              fi
            fi

            echo "✅ Branch validation passed."

  test-and-build:
    needs: check-branches
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - uses: actions/checkout@v4

      # Cache Gradle packages
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Setup JDK
      - name: Setup JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      # Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 9.2.0

      # Ensure wrapper is executable
      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Run Tests
        run: ./gradlew clean test --no-daemon

      - name: Upload Coverage Report (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html

      - name: JaCoCo Code Coverage Report
        if: ${{ !startsWith(github.head_ref, 'hotfix/') }}
        uses: PavanMudigonda/jacoco-reporter@v5.0
        with:
          coverage_results_path: build/reports/jacoco/test/jacocoTestReport.xml
          coverage_report_name: Coverage
          coverage_report_title: JaCoCo
          minimum_coverage: 100
          fail_below_threshold: true
          publish_only_summary: true          

  dependency-submission:
    needs: test-and-build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@v4