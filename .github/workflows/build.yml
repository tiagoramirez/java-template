name: Java CI with Gradle

on:
  pull_request:
    branches: ["develop", "main"]

jobs:
  check-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch names
        run: |
            branch_regex_release='^release/[0-9]+\\.[0-9]+\\.[0-9]+$'
            branch_regex_feature='^feature/.+$'

            head="${{ github.head_ref }}"
            base="${{ github.base_ref }}"
            
            if [[ "$base" == "main" && ! "$head" =~ $branch_regex_release ]]; then
              echo "❌ Merge to 'main' is only allowed from release/* branches (semantic versioning)."
              exit 1
            elif [[ "$base" == "develop" && ! "$head" =~ $branch_regex_feature ]]; then
              echo "❌ Merge to 'develop' is only allowed from feature/* branches."
              exit 1
            else
              echo "✅ Branch validation passed."
            fi

  test-and-build:
    needs: check-branches
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - uses: actions/checkout@v4

      # Cache Gradle packages
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Setup JDK
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.10.1

      # Ensure wrapper is executable
      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Run Tests
        run: ./gradlew clean test --no-daemon

      - name: Upload Coverage Report (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html

      - name: JaCoCo Code Coverage Report
        uses: PavanMudigonda/jacoco-reporter@v5.0
        with:
          coverage_results_path: build/reports/jacoco/report.xml
          coverage_report_name: Coverage
          coverage_report_title: JaCoCo
          minimum_coverage: 100
          fail_below_threshold: true
          publish_only_summary: true          

  dependency-submission:
    needs: test-and-build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@v4