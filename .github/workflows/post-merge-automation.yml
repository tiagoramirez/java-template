name: Post-Merge Automation

on:
  pull_request:
    types: [closed]
    branches: ["main"]

jobs:
  create-hotfix-pr:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'hotfix/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Create PR to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          hotfix_branch="${{ github.event.pull_request.head.ref }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"

          # Verify branch exists (may be auto-deleted)
          if ! git ls-remote --heads origin "$hotfix_branch" | grep -q "$hotfix_branch"; then
            echo "‚ö†Ô∏è Branch $hotfix_branch no longer exists (likely auto-deleted)"
            exit 0
          fi

          # Check for existing PR
          existing_pr=$(gh pr list --head "$hotfix_branch" --base develop --state open --json number --jq '.[0].number')

          if [[ -n "$existing_pr" ]]; then
            echo "‚ÑπÔ∏è PR already exists: #$existing_pr"
            exit 0
          fi

          # Create PR body
          pr_body="## Automated Hotfix Backport

This PR was automatically created after merging hotfix to \`main\` (PR #${pr_number}).

### Original PR
- **Branch**: \`$hotfix_branch\`
- **Title**: $pr_title
- **Merged to**: \`main\`

### Purpose
Backport hotfix changes to \`develop\` branch to ensure consistency between production and development environments.

### Verification
Please review the changes. If merge conflicts exist, resolve them before merging.

---
ü§ñ Generated by GitHub Actions"

          # Create PR (conflicts will be shown in GitHub UI)
          gh pr create \
            --title "[$hotfix_branch] Backport to develop" \
            --body "$pr_body" \
            --base develop \
            --head "$hotfix_branch" \
            --label "automated,hotfix-backport" \
            || echo "‚ö†Ô∏è PR creation failed (manual intervention required)"
