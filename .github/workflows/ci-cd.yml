name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: ["develop", "main"]

jobs:
  info:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "action=${{ github.event.action }}"
          echo "merged=${{ github.event.pull_request.merged }}"
          echo "branch=${{ github.head_ref }} → ${{ github.base_ref }}"

  check-branches:
    if: github.event.action != 'closed'
    needs: info
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch names and create RC tags
        run: |
            branch_regex_release='^release/[0-9]+\.[0-9]+\.[0-9]+$'
            branch_regex_feature='^feature/.+$'
            branch_regex_hotfix='^hotfix/.+$'

            head="${{ github.head_ref }}"
            base="${{ github.base_ref }}"

            if [[ "$base" == "main" ]]; then
              if [[ ! "$head" =~ $branch_regex_release ]] && [[ ! "$head" =~ $branch_regex_hotfix ]]; then
                echo "❌ Merge to 'main' is only allowed from release/* or hotfix/* branches."
                exit 1
              fi

              # Create RC tag for release branches
              if [[ "$head" =~ $branch_regex_release ]]; then
                version="${head#release/}"
                latest_rc=$(git tag -l "${version}-rc.*" | sort -V | tail -n 1)

                if [[ -z "$latest_rc" ]]; then
                  rc_tag="${version}-rc.1"
                else
                  rc_num=$(echo "$latest_rc" | sed 's/.*-rc\.//')
                  next_num=$((rc_num + 1))
                  rc_tag="${version}-rc.${next_num}"
                fi

                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git tag -a "$rc_tag" -m "Release candidate $rc_tag for PR #${{ github.event.pull_request.number }}"
                git push origin "$rc_tag"
                echo "✅ RC tag $rc_tag created"
              fi
            elif [[ "$base" == "develop" ]]; then
              if [[ ! "$head" =~ $branch_regex_feature ]] && [[ ! "$head" =~ $branch_regex_hotfix ]]; then
                echo "❌ Merge to 'develop' is only allowed from feature/* or hotfix/* branches."
                exit 1
              fi
            fi

            echo "✅ Branch validation passed."

  test-and-build:
    if: github.event.action != 'closed'
    needs: check-branches
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - uses: actions/checkout@v4

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 9.2.0

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Run Tests
        run: ./gradlew clean test --no-daemon

      - name: Upload Coverage Report (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html

      - name: JaCoCo Code Coverage Report
        if: ${{ !startsWith(github.head_ref, 'hotfix/') }}
        uses: PavanMudigonda/jacoco-reporter@v5.0
        with:
          coverage_results_path: build/reports/jacoco/test/jacocoTestReport.xml
          coverage_report_name: Coverage
          coverage_report_title: JaCoCo
          minimum_coverage: 100
          fail_below_threshold: true
          publish_only_summary: true

  dependency-submission:
    if: github.event.action != 'closed'
    needs: test-and-build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@v4

  create-release-tag:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/') && github.base_ref == 'main'
    needs: info
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release tag
        run: |
          release_branch="${{ github.event.pull_request.head.ref }}"
          pr_number="${{ github.event.pull_request.number }}"
          version="${release_branch#release/}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$version" -m "Release $version (PR #${pr_number})"
          git push origin "$version"
          echo "✅ Release tag $version created"

  create-hotfix-pr:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'hotfix/') && github.base_ref == 'main'
    needs: info
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Create PR to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          hotfix_branch="${{ github.event.pull_request.head.ref }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"

          # Verify branch exists (may be auto-deleted)
          if ! git ls-remote --heads origin "$hotfix_branch" | grep -q "$hotfix_branch"; then
            echo "⚠️ Branch $hotfix_branch no longer exists (likely auto-deleted)"
            exit 0
          fi

          # Check for existing PR
          existing_pr=$(gh pr list --head "$hotfix_branch" --base develop --state open --json number --jq '.[0].number')

          if [[ -n "$existing_pr" ]]; then
            echo "ℹ️ PR already exists: #$existing_pr"
            exit 0
          fi

          pr_body="This PR was automatically created by the CI/CD pipeline to backport hotfix changes from #$pr_number to develop.\n\nOriginal PR title: $pr_title"

          gh pr create \
            --title "[$hotfix_branch] Backport to develop" \
            --body "$pr_body" \
            --base develop \
            --head "$hotfix_branch" \
            --label "automated,hotfix-backport" \
            || echo "⚠️ PR creation failed (manual intervention required)"
